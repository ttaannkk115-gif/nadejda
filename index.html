<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Master –†–µ–µ—Å—Ç—Ä v3.0 Cloud</title>
    <style>
        :root { --primary: #1a73e8; --success: #28a745; --danger: #dc3545; --bg: #f8f9fa; --accent: #e8f0fe; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .card { background: #fff; border: 1px solid #eef0f2; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media (min-width: 600px) { .grid { grid-template-columns: 1fr 1fr; } .span-2 { grid-column: span 2; } }
        label { font-size: 11px; font-weight: 700; color: #888; text-transform: uppercase; margin-bottom: 4px; display: block; }
        input, textarea, button { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-size: 16px; outline: none; }
        .readonly-field { background: #f1f3f4 !important; color: #5f6368 !important; border: 1px dashed #ccc !important; }
        button { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-add { background: var(--success); }
        .table-scroll { overflow-x: auto; margin-top: 15px; border: 1px solid #eee; border-radius: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 1000px; font-size: 13px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background: #f8f9fa; }
        #adminArea { display: none; margin-top: 20px; border-top: 2px solid #eee; padding-top: 20px; }
        .loading-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.8); z-index: 10000; align-items:center; justify-content:center; font-weight: bold; }
        @media print { .no-print { display: none !important; } #adminArea { display: block !important; } @page { size: landscape; } }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –æ–±–ª–∞–∫–æ–º...</div>

<div class="container">
    <h1 class="no-print" style="text-align:center; font-size:22px;">üìã –û–±–ª–∞—á–Ω—ã–π –†–µ–µ—Å—Ç—Ä Master</h1>

    <div class="card no-print">
        <div class="grid">
            <div><label>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è (–∞–≤—Ç–æ)</label><input type="datetime-local" id="c_date" class="readonly-field" readonly></div>
            <div><label>–§–ò–û –ó–∞—è–≤–∏—Ç–µ–ª—è</label><input type="text" id="c_name" placeholder="–û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ"></div>
            <div><label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (–∑–∞—è–≤.)</label><input type="date" id="c_birth"></div>
            <div><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="tel" id="c_phone" placeholder="+7..."></div>
            <div class="span-2"><label>–ê–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è</label><input type="text" id="c_address"></div>
            <div><label>–§–ò–û –ù—É–∂–¥–∞—é—â–µ–≥–æ—Å—è</label><input type="text" id="c_need_name"></div>
            <div><label>–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è (–Ω—É–∂–¥.)</label><input type="date" id="c_need_birth"></div>
            <div class="span-2"><label>–î–∏–∞–≥–Ω–æ–∑ / –ü—Ä–∏—á–∏–Ω–∞</label><textarea id="c_diag" rows="2"></textarea></div>
            <button class="span-2 btn-add" onclick="submitToFirebase()">üöÄ –û–¢–ü–†–ê–í–ò–¢–¨ –í –û–ë–õ–ê–ö–û</button>
        </div>
    </div>

    <div class="card no-print" style="background: var(--accent);">
        <label>–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—á–µ—Ä–µ–¥—å</label>
        <div style="display:flex; gap:8px;">
            <input type="text" id="s_query" placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û –∑–∞—è–≤–∏—Ç–µ–ª—è...">
            <button onclick="searchCloud()" style="width:120px;">–ü–û–ò–°–ö</button>
        </div>
        <div id="res" style="display:none; margin-top:10px; padding:15px; background:white; border-radius:10px; border:1px solid #c2dbff;">
            <span id="res_name" style="font-weight:bold;"></span> ‚Äî –ü–æ–∑–∏—Ü–∏—è –≤ —Ä–µ–µ—Å—Ç—Ä–µ: 
            <span id="res_pos" style="font-size:22px; font-weight:900; color:var(--primary);"></span>
        </div>
    </div>

    <div class="no-print" style="text-align:center; color:#bbb; cursor:pointer; padding:20px;" onclick="toggleAdmin()">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
    
    <div id="pass_box" class="no-print" style="display:none; text-align:center; margin-bottom: 20px;">
        <input type="password" id="p_word" placeholder="–ü–∞—Ä–æ–ª—å" style="max-width:150px; display:inline-block;">
        <button onclick="login()" style="width:auto; padding:12px 20px; background:var(--success)">–í–•–û–î</button>
    </div>

    <div id="adminArea">
        <div style="display:flex; justify-content:space-between; align-items:center;" class="no-print">
            <h2 style="margin:0;">üìä –ü–æ–ª–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä (–û–±–ª–∞–∫–æ)</h2>
            <button onclick="window.print()" style="background:#6c757d; width:auto; padding:10px 20px;">üñ®Ô∏è –ü–ï–ß–ê–¢–¨ –í PDF</button>
        </div>
        <div class="table-scroll">
            <table>
                <thead>
                    <tr>
                        <th>‚Ññ</th>
                        <th>–î–∞—Ç–∞/–í—Ä–µ–º—è</th>
                        <th>–ó–∞—è–≤–∏—Ç–µ–ª—å</th>
                        <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                        <th>–ê–¥—Ä–µ—Å</th>
                        <th>–ù—É–∂–¥–∞—é—â–∏–π—Å—è</th>
                        <th>–î–∏–∞–≥–Ω–æ–∑</th>
                        <th class="no-print">–î–µ–π—Å—Ç–≤–∏–µ</th>
                    </tr>
                </thead>
                <tbody id="t_body"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ Master
    const FIREBASE_URL = "https://zaavka-d0788-default-rtdb.firebaseio.com/registry.json";

    const fmtDT = (dt) => {
        const d = new Date(dt);
        return d.toLocaleDateString('ru-RU') + '<br><b>' + d.toLocaleTimeString('ru-RU', {hour:'2-digit', minute:'2-digit'}) + '</b>';
    };
    const fmtD = (d) => d ? d.split('-').reverse().join('.') : '-';

    window.onload = () => {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        document.getElementById('c_date').value = now.toISOString().slice(0, 16);
    };

    function toggleAdmin() {
        const b = document.getElementById('pass_box');
        b.style.display = b.style.display === 'none' ? 'block' : 'none';
    }

    async function submitToFirebase() {
        const fields = {
            name: 'c_name', birth: 'c_birth', phone: 'c_phone', 
            address: 'c_address', need_name: 'c_need_name', 
            need_birth: 'c_need_birth', diag: 'c_diag'
        };
        
        let data = { date: document.getElementById('c_date').value };
        for(let key in fields) {
            const val = document.getElementById(fields[key]).value.trim();
            if(!val) return alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
            data[key] = val;
        }

        showLoader(true);
        try {
            await fetch(FIREBASE_URL, { method: 'POST', body: JSON.stringify(data) });
            alert("–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ –æ–±–ª–∞–∫–µ!");
            location.reload();
        } catch (e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç."); }
        showLoader(false);
    }

    async function loadFromCloud() {
        showLoader(true);
        try {
            const res = await fetch(FIREBASE_URL);
            const data = await res.json();
            const b = document.getElementById('t_body');
            b.innerHTML = '';
            
            if(!data) { b.innerHTML = '<tr><td colspan="8" style="text-align:center;">–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –ø—É—Å—Ç–∞</td></tr>'; return []; }

            const items = Object.keys(data).map(key => ({ fid: key, ...data[key] }));
            items.sort((a, b) => new Date(a.date) - new Date(b.date));

            items.forEach((it, i) => {
                b.innerHTML += `<tr>
                    <td><b>${i+1}</b></td>
                    <td style="color:var(--primary);">${fmtDT(it.date)}</td>
                    <td>${it.name}<br><small>${fmtD(it.birth)}</small></td>
                    <td>${it.phone}</td>
                    <td><small>${it.address}</small></td>
                    <td>${it.need_name}<br><small>${fmtD(it.need_birth)}</small></td>
                    <td><small>${it.diag}</small></td>
                    <td class="no-print">
                        <button onclick="deleteRow('${it.fid}')" style="background:var(--danger); padding:5px; width:35px;">‚úï</button>
                    </td>
                </tr>`;
            });
            return items;
        } catch (e) { alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö!"); return []; }
        finally { showLoader(false); }
    }

    async function deleteRow(fid) {
        if(!confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å –∏–∑ –æ–±–ª–∞–∫–∞ –Ω–∞–≤—Å–µ–≥–¥–∞?")) return;
        showLoader(true);
        const url = FIREBASE_URL.replace('.json', `/${fid}.json`);
        await fetch(url, { method: 'DELETE' });
        loadFromCloud();
    }

    async function searchCloud() {
        const q = document.getElementById('s_query').value.toLowerCase().trim();
        if(!q) return;
        const resDiv = document.getElementById('res');
        resDiv.style.display = 'none';
        
        showLoader(true);
        const res = await fetch(FIREBASE_URL);
        const data = await res.json();
        showLoader(false);

        if(!data) return alert("–ë–∞–∑–∞ –ø—É—Å—Ç–∞");

        const items = Object.keys(data).map(key => data[key]);
        items.sort((a, b) => new Date(a.date) - new Date(b.date));
        
        const idx = items.findIndex(it => it.name.toLowerCase().includes(q));
        if(idx !== -1) {
            resDiv.style.display = 'block';
            document.getElementById('res_name').innerText = items[idx].name;
            document.getElementById('res_pos').innerText = "‚Ññ" + (idx + 1);
        } else alert("–ó–∞—è–≤–∏—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ.");
    }

    function login() {
        if(document.getElementById('p_word').value === '01') {
            document.getElementById('adminArea').style.display = 'block';
            document.getElementById('pass_box').style.display = 'none';
            loadFromCloud();
        } else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.");
    }

    function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }
</script>
</body>
</html>
